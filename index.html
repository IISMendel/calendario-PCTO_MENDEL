<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>üìö Calendario PCTO 2025-2026 - Interactive Dashboard</title>
<style>
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --accent-color: #f093fb;
      --success-color: #4ecdc4;
      --warning-color: #feca57;
      --danger-color: #ff6b6b;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
      --shadow-medium: 0 8px 25px rgba(0,0,0,0.15);
      --shadow-heavy: 0 15px 35px rgba(0,0,0,0.2);
      --border-radius: 16px;
      --transition: all .25s cubic-bezier(.4, 0, .2, 1);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; padding:0; width:100%; overflow-x:hidden; }
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      min-height: 100vh; color: var(--text-primary);
    }
    .main-container { max-width: 1400px; margin:0 auto; padding:20px; }
    .dashboard-header { text-align:center; margin-bottom:32px; color:#fff; }
    .dashboard-title {
      font-size: 3rem; font-weight:800; margin:0 0 8px;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; color:#FFD700;
    }
    .dashboard-subtitle { font-size:1.1rem; opacity:.95; }

    .calendar-container {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border-radius: 24px;
      box-shadow: var(--shadow-heavy);
      overflow: hidden;
    }
    .tabs-container { display:flex; flex-wrap:wrap; background: linear-gradient(135deg, var(--dark-color), #34495e); }
    .tab { flex:1; padding:16px; background:transparent; border:none; color:rgba(255,255,255,0.75);
      cursor:pointer; font-size:1rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase; transition:var(--transition); }
    .tab:hover { color:#fff; background:rgba(255,255,255,0.1); }
    .tab.active { color:#fff; background:rgba(255,255,255,0.18); position:relative; }
    .tab.active::after { content:''; position:absolute; left:0; right:0; bottom:0; height:4px;
      background: linear-gradient(90deg, var(--accent-color), var(--success-color)); }

    .calendar-content { padding:24px; }
    .content-section { display:none; }
    .content-section.active { display:block; animation: fadeIn .4s ease; }

    /* Mensile */
    .month-header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; flex-wrap:wrap; }
    .nav-buttons-group { display: flex; gap: 8px; align-items: center; }
    .nav-button { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff;
      width:44px; height:44px; border-radius:50%; border:none; font-size:1.2rem; display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-light); cursor:pointer; transition:var(--transition); }
    .nav-button:hover { transform:scale(1.06); box-shadow: var(--shadow-medium); }
    .current-period { font-size:1.6rem; font-weight:800; min-width:220px; text-align:center; color:var(--text-primary); }
    .month-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:2px; background:var(--light-color);
      border-radius: var(--border-radius); overflow:hidden; box-shadow: var(--shadow-light); }
    .month-day-header { background:var(--dark-color); color:#fff; padding:12px 8px; text-align:center; font-weight:700; font-size:.9rem; letter-spacing:.06em; }
    .month-day { background:#fff; padding:10px; min-height:110px; border:1px solid transparent; position:relative; display:flex; flex-direction:column; cursor:pointer; }
    .month-day.other-month { background:#f8f9fa; color:var(--text-secondary); cursor:default; }
    .month-day.has-activity { border-left:5px solid var(--primary-color); }
    .month-day.today { outline:3px solid #FF1744; outline-offset:-3px; border-radius:6px; }
    .day-number { font-size:1.1rem; font-weight:800; margin-bottom:6px; color:var(--text-primary); }
    .activity-tag { background: linear-gradient(135deg, var(--accent-color), var(--primary-color)); color:#fff;
      padding:4px 8px; border-radius:14px; font-size:.78rem; font-weight:700; align-self:flex-start; }

    /* Settimanale */
    .week-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: var(--light-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow-light);
    }
    .week-day-header {
      background: linear-gradient(135deg, var(--dark-color), #34495e);
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 700;
      font-size: .9rem;
    }
    .week-day {
      background: white;
      min-height: 110px;
      padding: 10px;
      border: 1px solid transparent;
      position: relative;
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }
    .week-day.other-month { background:#f8f9fa; color:var(--text-secondary); cursor:default; }
    .week-day.has-activity { border-left:5px solid var(--primary-color); }
    .week-day.today { outline:3px solid #FF1744; outline-offset:-3px; border-radius:6px; }

    /* Annuale */
    .year-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; }
    @media (max-width: 1100px) { .year-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px)  { .year-grid { grid-template-columns: 1fr; } }
    .mini-month {
      background:#fff; border-radius: var(--border-radius); box-shadow: var(--shadow-light);
      padding:16px; display:flex; flex-direction:column; min-height:320px;
      transition:var(--transition); overflow:hidden;
    }
    .mini-month:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); }
    .mini-month-header { text-align:center; font-size:1.15rem; font-weight:800; color:var(--text-primary);
      margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid var(--light-color); }
    .mini-month-grid {
      display:grid; grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 1fr; gap:4px; flex:1 1 auto; min-height: 0;
    }
    .mini-dow { font-size:.7rem; font-weight:700; text-align:center; color:#7f8c8d; padding:4px 0; }
    .mini-day {
      background:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-size:.9rem; color:var(--text-primary); border:1px solid #eef2f7; min-height:32px;
      transition:var(--transition); cursor:pointer; flex-direction:column; padding:2px;
    }
    .mini-day.muted { background:#f8f9fb; color:#b6c0c8; cursor:default; }
    .mini-day.has-activity { background: var(--primary-color); color:#fff; font-weight:700; flex-direction:column; line-height:1.0; }
    .mini-day.today { outline:2px solid #FF1744; outline-offset:-2px; border-radius:8px; }
    .mini-activity-text { 
      font-size:.7rem; 
      margin-top:1px; 
      font-weight: 800;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      letter-spacing: 0.02em;
    }
    
    /* Enhanced class distinction in annual view */
    .mini-day.has-activity .mini-activity-text {
      font-size: 0.75rem;
      font-weight: 800;
      padding: 2px 4px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      margin-top: 2px;
      display: block;
      text-align: center;
    }
    
    /* Filtered legend for multi-select */
    .filtered-legend {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      border: 2px solid var(--primary-color);
    }
    
    .filtered-legend h5 {
      margin: 0 0 8px 0;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .filtered-legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .filtered-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: white;
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .filtered-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Multi-Select Class Filter Styles */
    .multi-class-filter {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-light);
      margin-bottom: 16px;
    }
    .multi-class-filter h4 {
      margin: 0 0 12px 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .class-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .class-checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f8f9fa;
      padding: 6px 12px;
      border-radius: 20px;
      border: 2px solid transparent;
      transition: var(--transition);
      cursor: pointer;
    }
    .class-checkbox-item:hover {
      background: #e9ecef;
    }
    .class-checkbox-item.checked {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-color: var(--primary-color);
    }
    .class-checkbox {
      margin: 0;
      cursor: pointer;
    }
    .class-checkbox-label {
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    .filter-controls {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: linear-gradient(135deg, var(--success-color), #38a169);
      border: none;
      color: white;
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 16px;
      cursor: pointer;
      transition: var(--transition);
    }
    .filter-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .filter-btn.secondary {
      background: linear-gradient(135deg, var(--text-secondary), #6c757d);
    }

    /* Google Calendar Direct Export Styles */
    .google-calendar-export {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow-light);
      margin-bottom: 16px;
    }
    .google-calendar-export h4 {
      margin: 0 0 12px 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .class-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .class-select {
      padding: 8px 12px;
      border: 2px solid var(--light-color);
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
    }
    .class-select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .export-to-gcal-btn {
      background: #4285F4;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .export-to-gcal-btn:hover {
      background: #3367d6;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .export-to-gcal-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Info/Foot */
    .info-panel { margin-top:28px; display:grid; grid-template-columns: 1fr; gap:20px; }
    .activity-details { background: rgba(255,255,255,0.92); border-radius: var(--border-radius); padding:20px; box-shadow: var(--shadow-light); }
    .activity-summary { background: linear-gradient(135deg, var(--accent-color), var(--success-color));
      color:#fff; padding:16px; border-radius:10px; margin-bottom:12px; }
      
    .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        justify-content: center;
    }

    .action-button {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      color: white;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .action-button.print { background: linear-gradient(135deg, #ff6b6b 0%, #d64a4a 100%); }
    .action-button.google-calendar { background: #4285F4; }
    .action-button.export-month { background: #E91E63; }
    .action-button.export-year { background: #673AB7; }
    .action-button.export-week { background: #FF9800; }

    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }
    
    .school-footer {
      background: linear-gradient(135deg, var(--dark-color), #34495e);
      color:#fff; text-align:center; padding:24px 16px; margin-top:32px; border-radius:24px 24px 0 0; box-shadow: var(--shadow-heavy);
    }
    .footer-title { font-size:1.05rem; font-weight:700; color:#FFD700; margin-bottom:6px; }
    .footer-address { font-size:.95rem; opacity:.9; }

    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
  </style>
<style>
@media print {
  .legend, .legend-container, #legend,
  .legend-section, .legend-title {
    display: none !important;
  }
}
</style>
</head>
<body>
<div class="main-container">
<div class="dashboard-header">
<h1 class="dashboard-title">üìö Calendario PCTO</h1>
<p class="dashboard-subtitle">Piano Percorsi Competenze Trasversali e Orientamento 2025-2026</p>
</div>
<div class="calendar-container">
<div class="tabs-container">
<button class="tab active" onclick="showTab(event,'monthly')">üìÖ Vista Mensile</button>
<button class="tab" onclick="showTab(event,'weekly')">üìä Vista Settimanale</button>
<button class="tab" onclick="showTab(event,'annual')">üóìÔ∏è Vista Annuale</button>
</div>
<div class="calendar-content">
<div class="content-section active" id="monthly">
<div class="month-header" style="display:flex; justify-content:space-between; align-items:center;">
<div class="nav-buttons-group">
<button class="nav-button" onclick="previousMonth()">‚Äπ</button>
<div class="current-period" id="monthTitle">Settembre 2025</div>
<button class="nav-button" onclick="nextMonth()">‚Ä∫</button>
</div>
<div class="class-filter"><label for="classFilterMonth">Filtra classe:</label><select class="action-button export-month" id="classFilterMonth" onchange="onClassFilterChange(this)"></select></div>
<div class="flex gap-2"><a class="action-button export-month" href="https://agrariomendel.edu.it/allegati/all/4998-piano-pcto-2025-2026.pdf" rel="noopener" target="_blank">Scarica PDF</a></div>
<button class="action-button export-month" onclick="exportCalendarToIcs('month')">
<svg class="feather feather-download" fill="none" height="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
              Esporta il mese
            </button>
</div>
<div class="month-grid" id="monthGrid"></div>
</div>

<div class="content-section" id="weekly">
<div class="week-header">
<div class="nav-buttons-group">
<button class="nav-button" onclick="previousWeek()">‚Äπ</button>
<div class="current-period" id="weekTitle">Settimana 1 - Settembre 2025</div>
<button class="nav-button" onclick="nextWeek()">‚Ä∫</button>
</div>
<button class="action-button export-week" onclick="exportCalendarToIcs('week')">
<svg class="feather feather-download" fill="none" height="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
              Esporta la settimana
            </button>
</div>
<div class="week-grid" id="weekGrid"></div>
</div>

<div class="content-section" id="annual">
<div class="current-period" style="text-align:center; margin-bottom:18px;">Anno Scolastico 2025-2026</div>

<!-- Google Calendar Direct Export -->
<div class="google-calendar-export">
  <h4>üìÖ Invia Calendario Classe a Google Calendar</h4>
  <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 0.9rem;">
    Seleziona una classe e invia tutti i suoi eventi direttamente a Google Calendar con un solo clic.
  </p>
  <div class="class-selector">
    <select class="class-select" id="classDirectExport">
      <option value="">Seleziona una classe...</option>
    </select>
    <button class="export-to-gcal-btn" onclick="exportClassToGoogleCalendar()" id="exportClassBtn" disabled>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
      </svg>
      Invia a Google Calendar
    </button>
  </div>
</div>

<!-- Multi-Select Class Filter for Annual View -->
<div class="multi-class-filter" id="multiClassFilter">
  <h4>üéØ Seleziona Classi da Visualizzare:</h4>
  <div class="class-checkboxes" id="classCheckboxes">
    <!-- Checkboxes will be populated by JavaScript -->
  </div>
  <div class="filter-controls">
    <button class="filter-btn" onclick="selectAllClasses()">Seleziona Tutte</button>
    <button class="filter-btn secondary" onclick="deselectAllClasses()">Deseleziona Tutte</button>
  </div>
</div>

<div class="year-grid" id="yearGrid"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="action-button export-year" onclick="exportCalendarToIcs('year')">
<svg class="feather feather-download" fill="none" height="18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
              Esporta l'anno
            </button>
</div>
</div>
</div>
</div>

<div class="info-panel">
<div class="activity-details">
<div class="activity-summary">
<h4>üìã Attivit√† Corrente</h4>
<p id="currentActivity">Nessuna attivit√† selezionata</p>
</div>
<div id="activityInfo">
<p>Seleziona una data nel calendario per visualizzare i dettagli delle attivit√† PCTO programmate.</p>
</div>
<div class="button-container" id="calendarButtons">
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="action-button print" onclick="window.print()">
            üñ®Ô∏è Stampa
          </button>
</div>
</div>
</div>

<div class="school-footer">
<div class="footer-title">Pagina creata dal Team Buone Pratiche dell'IIS MENDEL</div>
<div class="footer-address">Via Ferrazzi 15 - 20035 Villa Cortese (MI)</div>
</div>

<div id="instructions" style="background:#fff; border-radius:16px; padding:20px; margin-top:20px; box-shadow:var(--shadow-light);">
<h3>Guida per l'esportazione e la sincronizzazione del calendario</h3>
<p>Il calendario offre diverse opzioni per sincronizzare le attivit√† con il tuo calendario personale:</p>
<ol>
<li>
<strong>üìÖ Invia Calendario Classe (NUOVO!):</strong> Nella vista annuale, seleziona una classe dal menu a discesa e clicca "Invia a Google Calendar" per aggiungere automaticamente tutti gli eventi della classe selezionata al tuo calendario Google.
        </li>
<li>
<strong>Esportare un'attivit√† singola:</strong> Clicca su un giorno del calendario con un evento. Apparir√† un pulsante che ti permetter√† di aggiungere quell'attivit√† specifica al tuo calendario in un solo passaggio.
        </li>
<li>
<strong>Esportare un mese, una settimana o l'anno intero:</strong> Clicca sul pulsante "Esporta il mese", "Esporta la settimana" o "Esporta l'anno" nella vista corrispondente. Verr√† scaricato un file in formato `.ics`.
        </li>
</ol>
<p>
<strong>Come importare un file .ics su Google Calendar:</strong>
<ol>
<li>Dopo aver scaricato il file, si aprir√† una nuova scheda che ti reindirizza alla pagina di importazione di Google Calendar.</li>
<li>In quella pagina, clicca su **"Seleziona un file dal computer"** e scegli il file .ics appena scaricato.</li>
<li>Scegli in quale calendario vuoi importare gli eventi e clicca su **"Importa"**.</li>
</ol>
</p>
<p>
<strong>Novit√† Vista Annuale:</strong> Nella vista annuale puoi ora selezionare pi√π classi contemporaneamente utilizzando le checkbox. Usa i pulsanti "Seleziona Tutte" e "Deseleziona Tutte" per una gestione rapida della visualizzazione.
</p>
</div>
</div>

<script>
    const pctoData = { "2025-09": { 1: { day: "L", activity: "Inizio attivit√† ordinaria", type: "Inizio attivit√† ordinaria", description: "Inizio attivit√† ordinaria" }, 12: { day: "V", activity: "INIZIO LEZIONI", type: "INIZIO LEZIONI", description: "INIZIO LEZIONI" }, 15: { day: "L", activity: "4PA", type: "4PA", description: "4PA" }, 16: { day: "M", activity: "4PA", type: "4PA", description: "4PA" }, 17: { day: "M", activity: "4PA", type: "4PA", description: "4PA" }, 18: { day: "G", activity: "4PA", type: "4PA", description: "4PA" }, 19: { day: "V", activity: "4PA", type: "4PA", description: "4PA" }, 22: { day: "L", activity: "4PB", type: "4PB", description: "4PB" }, 23: { day: "M", activity: "4PB", type: "4PB", description: "4PB" }, 24: { day: "M", activity: "4PB", type: "4PB", description: "4PB" }, 25: { day: "G", activity: "4PB", type: "4PB", description: "4PB" }, 26: { day: "V", activity: "4PB", type: "4PB", description: "4PB" }, 29: { day: "L", activity: "3PA", type: "3PA", description: "3PA" }, 30: { day: "M", activity: "3PA", type: "3PA", description: "3PA" } }, "2025-10": { 1: { day: "M", activity: "3PA", type: "3PA", description: "3PA" }, 2: { day: "G", activity: "3PA", type: "3PA", description: "3PA" }, 3: { day: "V", activity: "3PA", type: "3PA", description: "3PA" }, 6: { day: "L", activity: "3PB", type: "3PB", description: "3PB" }, 7: { day: "M", activity: "3PB", type: "3PB", description: "3PB" }, 8: { day: "M", activity: "3PB", type: "3PB", description: "3PB" }, 9: { day: "G", activity: "3PB", type: "3PB", description: "3PB" }, 10: { day: "V", activity: "3PB", type: "3PB", description: "3PB" }, 13: { day: "L", activity: "3PC", type: "3PC", description: "3PC" }, 14: { day: "M", activity: "3PC", type: "3PC", description: "3PC" }, 15: { day: "M", activity: "3PC", type: "3PC", description: "3PC" }, 16: { day: "G", activity: "3PC", type: "3PC", description: "3PC" }, 17: { day: "V", activity: "3PC", type: "3PC", description: "3PC" }, 20: { day: "L", activity: "4A", type: "4A", description: "4A" }, 21: { day: "M", activity: "4A", type: "4A", description: "4A" }, 22: { day: "M", activity: "4A", type: "4A", description: "4A" }, 23: { day: "G", activity: "4A", type: "4A", description: "4A" }, 24: { day: "V", activity: "4A", type: "4A", description: "4A" }, 27: { day: "L", activity: "4B", type: "4B", description: "4B" }, 28: { day: "M", activity: "4B", type: "4B", description: "4B" }, 29: { day: "M", activity: "4B", type: "4B", description: "4B" }, 30: { day: "G", activity: "4B", type: "4B", description: "4B" }, 31: { day: "V", activity: "SOSPENSIONE DIDATTICA", type: "SOSPENSIONE DIDATTICA", description: "SOSPENSIONE DIDATTICA" } }, "2025-11": { 1: { day: "S", activity: "Ognissanti", type: "Ognissanti", description: "Ognissanti" }, 3: { day: "L", activity: "4C", type: "4C", description: "4C" }, 4: { day: "M", activity: "4C", type: "4C", description: "4C" }, 5: { day: "M", activity: "4C", type: "4C", description: "4C" }, 6: { day: "G", activity: "4C", type: "4C", description: "4C" }, 7: { day: "V", activity: "4C", type: "4C", description: "4C" }, 10: { day: "L", activity: "4D", type: "4D", description: "4D" }, 11: { day: "M", activity: "4D", type: "4D", description: "4D" }, 12: { day: "M", activity: "4D", type: "4D", description: "4D" }, 13: { day: "G", activity: "4D", type: "4D", description: "4D" }, 14: { day: "V", activity: "4D", type: "4D", description: "4D" }, 17: { day: "L", activity: "4PA", type: "4PA", description: "4PA" }, 18: { day: "M", activity: "4PA", type: "4PA", description: "4PA" }, 19: { day: "M", activity: "4PA", type: "4PA", description: "4PA" }, 20: { day: "G", activity: "4PA", type: "4PA", description: "4PA" }, 21: { day: "V", activity: "4PA", type: "4PA", description: "4PA" }, 24: { day: "L", activity: "4PB", type: "4PB", description: "4PB" }, 25: { day: "M", activity: "4PB", type: "4PB", description: "4PB" }, 26: { day: "M", activity: "4PB", type: "4PB", description: "4PB" }, 27: { day: "G", activity: "4PB", type: "4PB", description: "4PB" }, 28: { day: "V", activity: "4PB", type: "4PB", description: "4PB" } }, "2025-12": { 1: { day: "L", activity: "3PA", type: "3PA", description: "3PA" }, 2: { day: "M", activity: "3PA", type: "3PA", description: "3PA" }, 3: { day: "M", activity: "3PA", type: "3PA", description: "3PA" }, 4: { day: "G", activity: "3PA", type: "3PA", description: "3PA" }, 5: { day: "V", activity: "3PA", type: "3PA", description: "3PA" }, 8: { day: "L", activity: "Immacolata", type: "Immacolata", description: "Immacolata" }, 9: { day: "M", activity: "3PB", type: "3PB", description: "3PB" }, 10: { day: "M", activity: "3PB", type: "3PB", description: "3PB" }, 11: { day: "G", activity: "3PB", type: "3PB", description: "3PB" }, 12: { day: "V", activity: "3PB", type: "3PB", description: "3PB" }, 15: { day: "L", activity: "3PC", type: "3PC", description: "3PC" }, 16: { day: "M", activity: "3PC", type: "3PC", description: "3PC" }, 17: { day: "M", activity: "3PC", type: "3PC", description: "3PC" }, 18: { day: "G", activity: "3PC", type: "3PC", description: "3PC" }, 19: { day: "V", activity: "3PC", type: "3PC", description: "3PC" }, 22: { day: "L", activity: "SOSPENSIONE DIDATTICA", type: "SOSPENSIONE DIDATTICA", description: "SOSPENSIONE DIDATTICA" }, 23: { day: "M", activity: "inizio vacanze di Natale", type: "inizio vacanze di Natale", description: "inizio vacanze di Natale" }, 25: { day: "G", activity: "SS. Natale", type: "SS. Natale", description: "SS. Natale" } }, "2026-01": { 6: { day: "M", activity: "Fine Vac. Natatale", type: "Fine Vac. Natatale", description: "Fine Vac. Natatale" }, 7: { day: "M", activity: "SOSPENSIONE PCTO", type: "SOSPENSIONE PCTO", description: "SOSPENSIONE PCTO" }, 16: { day: "V", activity: "FINE 1Q", type: "FINE 1Q", description: "FINE 1Q" }, 19: { day: "L", activity: "2PA", type: "2PA", description: "2PA" }, 20: { day: "M", activity: "2PA", type: "2PA", description: "2PA" }, 21: { day: "M", activity: "2PA", type: "2PA", description: "2PA" }, 22: { day: "G", activity: "2PA", type: "2PA", description: "2PA" }, 23: { day: "V", activity: "2PA", type: "2PA", description: "2PA" }, 26: { day: "L", activity: "2PB", type: "2PB", description: "2PB" }, 27: { day: "M", activity: "2PB", type: "2PB", description: "2PB" }, 28: { day: "M", activity: "2PB", type: "2PB", description: "2PB" }, 29: { day: "G", activity: "2PB", type: "2PB", description: "2PB" }, 30: { day: "V", activity: "2PB", type: "2PB", description: "2PB" } }, "2026-02": { 2: { day: "L", activity: "3A", type: "3A", description: "3A" }, 3: { day: "M", activity: "3A", type: "3A", description: "3A" }, 4: { day: "M", activity: "3A", type: "3A", description: "3A" }, 5: { day: "G", activity: "3A", type: "3A", description: "3A" }, 6: { day: "V", activity: "3A", type: "3A", description: "3A" }, 9: { day: "L", activity: "3B", type: "3B", description: "3B" }, 10: { day: "M", activity: "3B", type: "3B", description: "3B" }, 11: { day: "M", activity: "3B", type: "3B", description: "3B" }, 12: { day: "G", activity: "3B", type: "3B", description: "3B" }, 13: { day: "V", activity: "3B", type: "3B", description: "3B" }, 16: { day: "L", activity: "3C", type: "3C", description: "3C" }, 17: { day: "M", activity: "3C", type: "3C", description: "3C" }, 18: { day: "M", activity: "3C", type: "3C", description: "3C" }, 19: { day: "G", activity: "3C", type: "3C", description: "3C" }, 20: { day: "V", activity: "CARNEVALE", type: "CARNEVALE", description: "CARNEVALE" }, 21: { day: "S", activity: "CARNEVALE", type: "CARNEVALE", description: "CARNEVALE" }, 23: { day: "L", activity: "3D", type: "3D", description: "3D" }, 24: { day: "M", activity: "3D", type: "3D", description: "3D" }, 25: { day: "M", activity: "3D", type: "3D", description: "3D" }, 26: { day: "G", activity: "3D", type: "3D", description: "3D" }, 27: { day: "V", activity: "3D", type: "3D", description: "3D" } }, "2026-03": { 2: { day: "L", activity: "4PA", type: "4PA", description: "4PA" }, 3: { day: "M", activity: "4PA", type: "4PA", description: "4PA" }, 4: { day: "M", activity: "4PA", type: "4PA", description: "4PA" }, 5: { day: "G", activity: "4PA", type: "4PA", description: "4PA" }, 6: { day: "V", activity: "4PA", type: "4PA", description: "4PA" }, 9: { day: "L", activity: "4PB", type: "4PB", description: "4PB" }, 10: { day: "M", activity: "4PB", type: "4PB", description: "4PB" }, 11: { day: "M", activity: "4PB", type: "4PB", description: "4PB" }, 12: { day: "G", activity: "4PB", type: "4PB", description: "4PB" }, 13: { day: "V", activity: "4PB", type: "4PB", description: "4PB" }, 16: { day: "L", activity: "3PA", type: "3PA", description: "3PA" }, 17: { day: "M", activity: "3PA", type: "3PA", description: "3PA" }, 18: { day: "M", activity: "3PA", type: "3PA", description: "3PA" }, 19: { day: "G", activity: "3PA", type: "3PA", description: "3PA" }, 20: { day: "V", activity: "3PA", type: "3PA", description: "3PA" }, 23: { day: "L", activity: "3PB", type: "3PB", description: "3PB" }, 24: { day: "M", activity: "3PB", type: "3PB", description: "3PB" }, 25: { day: "M", activity: "3PB", type: "3PB", description: "3PB" }, 26: { day: "G", activity: "3PB", type: "3PB", description: "3PB" }, 27: { day: "V", activity: "3PB", type: "3PB", description: "3PB" }, 30: { day: "L", activity: "3PC", type: "3PC", description: "3PC" }, 31: { day: "M", activity: "3PC", type: "3PC", description: "3PC" } }, "2026-04": { 1: { day: "M", activity: "3PC", type: "3PC", description: "3PC" }, 2: { day: "G", activity: "VAC. PASQUALI", type: "VAC. PASQUALI", description: "VAC. PASQUALI" }, 3: { day: "V", activity: "VAC. PASQUALI", type: "VAC. PASQUALI", description: "VAC. PASQUALI" }, 4: { day: "S", activity: "VAC. PASQUALI", type: "VAC. PASQUALI", description: "VAC. PASQUALI" }, 5: { day: "D", activity: "VAC. PASQUALI", type: "VAC. PASQUALI", description: "VAC. PASQUALI" }, 6: { day: "L", activity: "VAC. PASQUALI", type: "VAC. PASQUALI", description: "VAC. PASQUALI" }, 7: { day: "M", activity: "VAC. PASQUALI", type: "VAC. PASQUALI", description: "VAC. PASQUALI" }, 8: { day: "M", activity: "3PC", type: "3PC", description: "3PC" }, 9: { day: "G", activity: "3PC", type: "3PC", description: "3PC" }, 10: { day: "V", activity: "3PC", type: "3PC", description: "3PC" }, 13: { day: "L", activity: "3A", type: "3A", description: "3A" }, 14: { day: "M", activity: "3A", type: "3A", description: "3A" }, 15: { day: "M", activity: "3A", type: "3A", description: "3A" }, 16: { day: "G", activity: "3A", type: "3A", description: "3A" }, 17: { day: "V", activity: "3A", type: "3A", description: "3A" }, 20: { day: "L", activity: "3B", type: "3B", description: "3B" }, 21: { day: "M", activity: "3B", type: "3B", description: "3B" }, 22: { day: "M", activity: "3B", type: "3B", description: "3B" }, 23: { day: "G", activity: "3B", type: "3B", description: "3B" }, 24: { day: "V", activity: "3B", type: "3B", description: "3B" }, 25: { day: "S", activity: "FESTA LIBERAZIONE", type: "FESTA LIBERAZIONE", description: "FESTA LIBERAZIONE" }, 27: { day: "L", activity: "3C", type: "3C", description: "3C" }, 28: { day: "M", activity: "3C", type: "3C", description: "3C" }, 29: { day: "M", activity: "3C", type: "3C", description: "3C" }, 30: { day: "G", activity: "3C", type: "3C", description: "3C" } }, "2026-05": { 1: { day: "V", activity: "F. Lavoratori", type: "F. Lavoratori", description: "F. Lavoratori" }, 4: { day: "L", activity: "3D", type: "3D", description: "3D" }, 5: { day: "M", activity: "3D", type: "3D", description: "3D" }, 6: { day: "M", activity: "3D", type: "3D", description: "3D" }, 7: { day: "G", activity: "3D", type: "3D", description: "3D" }, 8: { day: "V", activity: "S. Patrono", type: "S. Patrono", description: "S. Patrono" }, 11: { day: "L", activity: "2PA", type: "2PA", description: "2PA" }, 12: { day: "M", activity: "2PA", type: "2PA", description: "2PA" }, 13: { day: "M", activity: "2PA", type: "2PA", description: "2PA" }, 14: { day: "G", activity: "2PA", type: "2PA", description: "2PA" }, 15: { day: "V", activity: "2PA", type: "2PA", description: "2PA" }, 18: { day: "L", activity: "2PB", type: "2PB", description: "2PB" }, 19: { day: "M", activity: "2PB", type: "2PB", description: "2PB" }, 20: { day: "M", activity: "2PB", type: "2PB", description: "2PB" }, 21: { day: "G", activity: "2PB", type: "2PB", description: "2PB" }, 22: { day: "V", activity: "2PB", type: "2PB", description: "2PB" }, 25: { day: "L", activity: "2PA", type: "2PA", description: "2PA" }, 26: { day: "M", activity: "2PA", type: "2PA", description: "2PA" }, 27: { day: "M", activity: "2PA", type: "2PA", description: "2PA" }, 28: { day: "G", activity: "2PA", type: "2PA", description: "2PA" }, 29: { day: "V", activity: "2PA", type: "2PA", description: "2PA" } }, "2026-06": { 1: { day: "L", activity: "SOSPENSIONE DIDATTICA", type: "SOSPENSIONE DIDATTICA", description: "SOSPENSIONE DIDATTICA" }, 2: { day: "M", activity: "F. Repubblica", type: "F. Repubblica", description: "F. Repubblica" }, 3: { day: "M", activity: "2PB", type: "2PB", description: "2PB" }, 4: { day: "G", activity: "2PB", type: "2PB", description: "2PB" }, 5: { day: "V", activity: "2PB", type: "2PB", description: "2PB" }, 8: { day: "L", activity: "TERMINE DELLE LEZIONI", type: "TERMINE DELLE LEZIONI", description: "TERMINE DELLE LEZIONI" }, 9: { day: "M", activity: "INIZIO PCTO ESTIVO", type: "INIZIO PCTO ESTIVO", description: "INIZIO PCTO ESTIVO" }, 17: { day: "M", activity: "INIZIO ESAMI STATO", type: "INIZIO ESAMI STATO", description: "INIZIO ESAMI STATO" } } };
    
    const activityColors = {
      "3PA": "#FF6B6B","4PA": "#4ECDC4","3PB": "#45B7D1","4PB": "#96CEB4","3PC": "#FECA57","4PC": "#FF9FF3",
      "2PA": "#54A0FF","2PB": "#5F27CD","3A": "#00D2D3","3B": "#FF9F43","3C": "#10AC84","3D": "#EE5A24",
      "4A": "#0984E3","4B": "#6C5CE7","4C": "#A29BFE","4D": "#FD79A8",
      "VACANZE": "#E17055","FESTIVIT√Ä": "#FDCB6E","SOSPENSIONE": "#BDC3C7","LEZIONI": "#00B894",
      "OGGI": "#FF1744","PCTO_ESTIVO": "#9C27B0","ESAMI": "#FF5722", "COLLEGIO": "#4ECDC4"
    };

    const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    const shortDays = ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"];
    let currentMonth = 8;
    let currentYear = 2025;
    let currentWeek = 0;
    let currentSelectedDayData = null;

    function showTab(ev, name){
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      ev.target.classList.add('active');
      if(name==='monthly') generateMonthlyView();
      if(name==='weekly')  generateWeeklyView();
      if(name==='annual')  generateAnnualView();
    }

    function todayInfo(){
      const now = new Date();
      return { y: now.getFullYear(), m: now.getMonth(), d: now.getDate() };
    }

    function generateMonthlyView(){
      const monthKey = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
      const first = new Date(currentYear, currentMonth, 1);
      const last  = new Date(currentYear, currentMonth+1, 0);
      const daysInMonth = last.getDate();
      const startDow = first.getDay();

      document.getElementById('monthTitle').textContent = `${months[currentMonth]} ${currentYear}`;
      let html = '';
      const daysOfWeek = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
      daysOfWeek.forEach(d => html += `<div class="month-day-header">${d}</div>`);
      
      const firstDayCorrected = (startDow === 0) ? 6 : startDow - 1;

      for(let i=0;i<firstDayCorrected;i++){ html += `<div class="month-day other-month"></div>`; }

      const t = todayInfo();
      for(let d=1; d<=daysInMonth; d++){
        const data = pctoData[monthKey] && pctoData[monthKey][d];
        const has = data ? 'has-activity' : '';
        const isToday = (currentYear===t.y && currentMonth===t.m && d===t.d) ? 'today' : '';
        const color = data ? (activityColors[data.type]||'#667eea') : null;
        const activityTag = data ? `<div class="activity-tag" data-type="${data.type}" style="background:${color}">${data.type}</div>` : '';

        html += `<div class="month-day ${has} ${isToday}" onclick="selectDay('${monthKey}', ${d})">`+
                  `<div class="day-number">${d}</div>`+
                  activityTag +
                `</div>`;
      }
      document.getElementById('monthGrid').innerHTML = html;

      if (typeof populateClassFilter==='function') populateClassFilter('classFilterMonth');
      if (typeof applyClassFilter==='function') applyClassFilter();
    }

    function generateWeeklyView(){
        let html = '';
        const weekStart = new Date(currentYear, currentMonth, 1);
        const firstDayOfWeek = weekStart.getDay();
        const startOffset = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1;
        weekStart.setDate(weekStart.getDate() - startOffset);
        weekStart.setDate(weekStart.getDate() + (currentWeek * 7));

        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        const weekTitle = `${weekStart.getDate()} ${months[weekStart.getMonth()]} ${weekStart.getFullYear()} - ${weekEnd.getDate()} ${months[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
        document.getElementById('weekTitle').textContent = weekTitle;
        
        const daysOfWeek = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
        daysOfWeek.forEach(d => html += `<div class="week-day-header">${d}</div>`);
        
        const t = todayInfo();
        for (let i = 0; i < 7; i++) {
            const day = new Date(weekStart);
            day.setDate(weekStart.getDate() + i);
            const monthKey = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}`;
            const dayData = pctoData[monthKey] && pctoData[day.getFullYear() + '-' + String(day.getMonth() + 1).padStart(2, '0')][day.getDate()];
            const hasActivity = dayData ? 'has-activity' : '';
            const isToday = (day.getFullYear() === t.y && day.getMonth() === t.m && day.getDate() === t.d) ? 'today' : '';
            const color = dayData ? (activityColors[dayData.type] || '#667eea') : null;
            const activityTag = dayData ? `<div class="activity-tag" style="background:${color}">${dayData.type}</div>` : '';

            html += `<div class="week-day ${hasActivity} ${isToday}" onclick="selectDay('${monthKey}', ${day.getDate()})">`+
                      `<div class="day-number">${day.getDate()}</div>`+
                      activityTag +
                    `</div>`;
        }
        document.getElementById('weekGrid').innerHTML = html;
    }

    function generateAnnualView(){
      const yearGrid = document.getElementById('yearGrid');
      let html = '';
      for(let m=8;m<12;m++){ html += miniMonthHTML(m, 2025); }
      for(let m=0;m<6;m++){ html += miniMonthHTML(m, 2026); }
      yearGrid.innerHTML = html;
      
      // Initialize multi-select filter after generating the annual view
      initializeMultiSelectFilter();
      initializeClassDirectExport();
      applyMultiClassFilter();
    }

    function miniMonthHTML(month, year){
      const monthKey = `${year}-${String(month+1).padStart(2,'0')}`;
      const first = new Date(year, month, 1);
      const last  = new Date(year, month+1, 0);
      const daysInMonth = last.getDate();
      const startDow = first.getDay();
      const t = todayInfo();
      const isCurrent = (year===t.y && month===t.m);
      let html = `<div class="mini-month"><div class="mini-month-header">${months[month]} ${year}</div><div class="mini-month-grid">`;
      const daysOfWeek = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
      daysOfWeek.forEach(d => html += `<div class="mini-dow">${d[0]}</div>`);
      
      const firstDayCorrected = (startDow === 0) ? 6 : startDow - 1;
      for(let i=0;i<firstDayCorrected;i++){ html += `<div class="mini-day muted"></div>`; }

      let filled = firstDayCorrected;
      for(let d=1; d<=daysInMonth; d++){
        const data = pctoData[monthKey] && pctoData[monthKey][d];
        const has = data ? 'has-activity' : '';
        const isToday = (isCurrent && d===t.d) ? 'today' : '';
        const color = data ? (activityColors[data.type]||'#667eea') : null;
        const activityTag = data ? `<div class="mini-activity-text activity-tag" data-type="${data.type}">${data.type}</div>` : '';

        html += `<div class="mini-day ${has} ${isToday}" ${color?`style="background:${color}"`:''} title="${data?data.activity:''}" onclick="selectDay('${monthKey}',${d})">`+
                  `${d}${activityTag}`+
                `</div>`;
        filled++;
      }
      while(filled < 7*6){ html += `<div class="mini-day muted"></div>`; filled++; }
      html += `</div></div>`;
      return html;
    }

    function previousMonth(){ if(currentMonth===0){ currentMonth=11; currentYear--; } else currentMonth--; generateMonthlyView(); }
    function nextMonth(){ if(currentMonth===11){ currentMonth=0; currentYear++; } else currentMonth++; generateMonthlyView(); }

    function previousWeek(){ 
      const newWeekStart = new Date(currentYear, currentMonth, 1 + ((currentWeek - 1) * 7));
      if (newWeekStart.getMonth() !== currentMonth && newWeekStart.getFullYear() === currentYear) {
        currentMonth--;
        currentWeek = Math.floor((new Date(currentYear, currentMonth + 1, 0).getDate() + new Date(currentYear, currentMonth, 1).getDay()) / 7);
      } else {
        currentWeek--;
      }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      generateWeeklyView(); 
    }
    
    function nextWeek(){ 
      const newWeekStart = new Date(currentYear, currentMonth, 1 + ((currentWeek + 1) * 7));
      if (newWeekStart.getMonth() !== currentMonth && newWeekStart.getFullYear() === currentYear) {
        currentMonth++;
        currentWeek = 0;
      } else {
        currentWeek++;
      }
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      generateWeeklyView();
    }

    function selectDay(monthKey, day){
      const data = pctoData[monthKey] && pctoData[monthKey][day];
      const calendarButtonsDiv = document.getElementById('calendarButtons');
      
      if(data && data.activity){
        document.getElementById('currentActivity').textContent = data.activity;
        document.getElementById('activityInfo').innerHTML = `<p><strong>Tipo:</strong> ${data.type}</p><p><strong>Giorno:</strong> ${data.day}</p><p><strong>Descrizione:</strong> ${data.description}</p>`;
        
        const date = new Date(monthKey.split('-')[0], monthKey.split('-')[1] - 1, day);
        const startDateString = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
        const endDateString = startDateString;
        
        const title = encodeURIComponent(data.activity);
        const details = encodeURIComponent(data.description);
        
        const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDateString}/${endDateString}&details=${details}`;
        
        calendarButtonsDiv.innerHTML = `
          <a href="${googleCalendarUrl}" target="_blank" class="action-button google-calendar">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            Aggiungi attivit√† singola
          </a>
        `;
      } else {
        document.getElementById('currentActivity').textContent = 'Nessuna attivit√† programmata';
        document.getElementById('activityInfo').innerHTML = '<p>Seleziona una data nel calendario per visualizzare i dettagli delle attivit√† PCTO programmate.</p>';
        document.getElementById('calendarButtons').innerHTML = '';
      }
    }

    function exportCalendarToIcs(scope) {
        let eventsToExport = {};
        let filename;
        
        if (scope === 'month') {
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            eventsToExport = pctoData[monthKey] || {};
            filename = `calendario-pcto-${months[currentMonth]}-${currentYear}.ics`;
        } else if (scope === 'year') {
            for (const monthKey in pctoData) {
                if (pctoData.hasOwnProperty(monthKey)) {
                    Object.assign(eventsToExport, pctoData[monthKey]);
                }
            }
            filename = `calendario-pcto-anno-scolastico-${currentYear}-${currentYear + 1}.ics`;
        } else if (scope === 'week') {
            const weekStart = new Date(currentYear, currentMonth, 1);
            const firstDayOfWeek = weekStart.getDay();
            const startOffset = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1;
            weekStart.setDate(weekStart.getDate() - startOffset);
            weekStart.setDate(weekStart.getDate() + (currentWeek * 7));

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            filename = `calendario-pcto-settimana-${weekStart.getDate()}-${weekEnd.getDate()}-${months[weekStart.getMonth()]}-${weekStart.getFullYear()}.ics`;
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                const dayKey = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}`;
                const dayData = pctoData[dayKey] && pctoData[day.getFullYear() + '-' + String(day.getMonth() + 1).padStart(2, '0')][day.getDate()];
                if (dayData) {
                    eventsToExport[day.getDate()] = dayData;
                }
            }
        }

        if (Object.keys(eventsToExport).length === 0) {
            alert(`Nessun evento PCTO trovato per questo ${scope === 'month' ? 'mese' : scope === 'year' ? 'anno' : 'periodo'}.`);
            return;
        }

        let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PCTO Calendar//NONSGML v1.0//EN
`;

        for (const day in eventsToExport) {
            const event = eventsToExport[day];
            const eventDate = new Date(currentYear, currentMonth, parseInt(day));
            const monthKey = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}`;
            
            if (event.type && event.type !== 'OGGI' && event.type !== 'LEZIONI') {
                const date = new Date(currentYear, currentMonth, parseInt(day));
                const isoDate = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
                
                icsContent += `BEGIN:VEVENT
`;
                icsContent += `UID:${isoDate}-${event.activity}@iismendel.edu.it
`;
                icsContent += `DTSTART;VALUE=DATE:${isoDate}
`;
                icsContent += `DTEND;VALUE=DATE:${isoDate}
`; 
                icsContent += `SUMMARY:PCTO - ${event.activity}
`;
                icsContent += `DESCRIPTION:${event.description}
`;
                icsContent += `END:VEVENT
`;
            }
        }
        icsContent += `END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        window.open('https://calendar.google.com/calendar/r/settings/export', '_blank');
        alert(`Il file "${filename}" √® stato scaricato. Ora importa il file in Google Calendar.`);
    }

    // --- Google Calendar Direct Export Functions ---
    function initializeClassDirectExport() {
      const select = document.getElementById('classDirectExport');
      const classes = collectClasses();
      
      // Clear existing options
      select.innerHTML = '<option value="">Seleziona una classe...</option>';
      
      classes.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        select.appendChild(option);
      });
      
      // Add event listener
      select.addEventListener('change', function() {
        const btn = document.getElementById('exportClassBtn');
        btn.disabled = !this.value;
      });
    }

    function exportClassToGoogleCalendar() {
      const selectedClass = document.getElementById('classDirectExport').value;
      if (!selectedClass) {
        alert('Seleziona prima una classe!');
        return;
      }
      
      const classEvents = getEventsForClass(selectedClass);
      if (classEvents.length === 0) {
        alert(`Nessun evento trovato per la classe ${selectedClass}.`);
        return;
      }
      
      // Create multiple Google Calendar URLs and open them
      const googleCalendarUrls = [];
      
      classEvents.forEach(event => {
        const title = encodeURIComponent(`PCTO - ${selectedClass}`);
        const details = encodeURIComponent(`Attivit√† PCTO per la classe ${selectedClass}: ${event.description}`);
        const location = encodeURIComponent('IIS Mendel - Via Ferrazzi 15, Villa Cortese');
        
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${event.startDate}/${event.endDate}&details=${details}&location=${location}`;
        googleCalendarUrls.push(url);
      });
      
      // Show confirmation dialog
      const confirmMsg = `Verranno aperti ${classEvents.length} nuove schede per aggiungere tutti gli eventi della classe ${selectedClass} al tuo Google Calendar. Continui?`;
      if (confirm(confirmMsg)) {
        // Open the first few immediately
        googleCalendarUrls.slice(0, 5).forEach((url, index) => {
          setTimeout(() => {
            window.open(url, '_blank');
          }, index * 500); // Delay each by 500ms to avoid popup blocking
        });
        
        // If there are more than 5 events, ask if user wants to continue
        if (googleCalendarUrls.length > 5) {
          setTimeout(() => {
            if (confirm(`Ci sono altri ${googleCalendarUrls.length - 5} eventi. Vuoi continuare ad aprire le rimanenti schede?`)) {
              googleCalendarUrls.slice(5).forEach((url, index) => {
                setTimeout(() => {
                  window.open(url, '_blank');
                }, index * 500);
              });
            }
          }, 3000);
        }
        
        alert(`Processo avviato! Verranno aperte ${classEvents.length} schede di Google Calendar per la classe ${selectedClass}. Assicurati di aver disabilitato il blocco popup.`);
      }
    }

    function getEventsForClass(className) {
      const events = [];
      
      for (const monthKey in pctoData) {
        for (const day in pctoData[monthKey]) {
          const event = pctoData[monthKey][day];
          if (event.type === className) {
            const [year, month] = monthKey.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const dateString = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
            
            events.push({
              title: event.activity,
              description: event.description,
              startDate: dateString,
              endDate: dateString,
              date: date
            });
          }
        }
      }
      
      // Sort events by date
      events.sort((a, b) => a.date - b.date);
      
      // Group consecutive days into single events
      const groupedEvents = [];
      let currentGroup = null;
      
      for (let i = 0; i < events.length; i++) {
        const event = events[i];
        const eventDate = new Date(event.date);
        
        if (currentGroup === null) {
          // Start new group
          currentGroup = {
            title: event.title,
            description: event.description,
            startDate: event.startDate,
            endDate: event.startDate,
            date: event.date,
            days: 1
          };
        } else {
          // Check if this event is consecutive to the previous one
          const prevDate = new Date(currentGroup.date);
          prevDate.setDate(prevDate.getDate() + currentGroup.days);
          
          if (eventDate.getTime() === prevDate.getTime()) {
            // Consecutive day - extend current group
            currentGroup.endDate = event.startDate;
            currentGroup.days++;
            if (currentGroup.days > 1) {
              currentGroup.description = `Settimana PCTO classe ${className} - ${currentGroup.days} giorni consecutivi`;
            }
          } else {
            // Not consecutive - save current group and start new one
            groupedEvents.push(currentGroup);
            currentGroup = {
              title: event.title,
              description: event.description,
              startDate: event.startDate,
              endDate: event.startDate,
              date: event.date,
              days: 1
            };
          }
        }
      }
      
      // Don't forget the last group
      if (currentGroup) {
        groupedEvents.push(currentGroup);
      }
      
      return groupedEvents;
    }

    document.addEventListener('DOMContentLoaded', () => {
      generateMonthlyView();
    });
  
    // --- Filtro classe (singola per vista mensile) ---
    var currentClassFilter = "";

    function isClassCode(t){
      return /^[1-5](PA|PB|PC|PD|A|B|C|D)$/.test((t||"").toUpperCase());
    }

    function collectClasses(){
      const classes = new Set();
      for (const month in pctoData){
        for (const day in pctoData[month]){
          const t = (pctoData[month][day].type||"").toUpperCase();
          if (isClassCode(t)) classes.add(t);
        }
      }
      return Array.from(classes).sort();
    }

    function populateClassFilter(selectId){
      const sel = document.getElementById(selectId);
      if (!sel) return;
      // reset options (keep "Tutte" if present)
      while (sel.options.length > 0) sel.remove(0);
      const optAll = document.createElement('option');
      optAll.value = ""; optAll.textContent = "Tutte";
      sel.appendChild(optAll);
      collectClasses().forEach(c => {
        const o = document.createElement('option');
        o.value = c; o.textContent = c; sel.appendChild(o);
      });
      sel.value = currentClassFilter || "";
    }

    function applyClassFilter(){
      const cls = (currentClassFilter||"").toUpperCase();
      document.querySelectorAll('.activity-tag').forEach(tag => {
        const t = (tag.getAttribute('data-type')||"").toUpperCase();
        const holder = tag.parentElement; // container of the tag inside the day cell/annual cell
        if (!holder) return;
        holder.style.display = (!cls || t===cls) ? "" : "none";
      });
    }

    function onClassFilterChange(sel){
      currentClassFilter = (sel.value||"").toUpperCase();
      // sync other filters if present
      ['classFilterMonth','classFilterYear'].forEach(id => {
        const el = document.getElementById(id);
        if (el && el!==sel) el.value = currentClassFilter;
      });
      applyClassFilter();
    }

    // --- Multi-Select Filter for Annual View ---
    let selectedClasses = new Set();

    function initializeMultiSelectFilter() {
      const container = document.getElementById('classCheckboxes');
      if (!container) return;
      
      const classes = collectClasses();
      container.innerHTML = '';
      
      classes.forEach(className => {
        const item = document.createElement('div');
        item.className = 'class-checkbox-item';
        item.onclick = () => toggleClass(className, item);
        
        item.innerHTML = `
          <input type="checkbox" class="class-checkbox" id="checkbox-${className}" ${selectedClasses.has(className) ? 'checked' : ''}>
          <label for="checkbox-${className}" class="class-checkbox-label">${className}</label>
        `;
        
        if (selectedClasses.has(className)) {
          item.classList.add('checked');
        }
        
        container.appendChild(item);
      });
      
      // If no classes are selected initially, select all
      if (selectedClasses.size === 0) {
        selectAllClasses();
      }
    }

    function toggleClass(className, itemElement) {
      const checkbox = itemElement.querySelector('input[type="checkbox"]');
      
      if (selectedClasses.has(className)) {
        selectedClasses.delete(className);
        checkbox.checked = false;
        itemElement.classList.remove('checked');
      } else {
        selectedClasses.add(className);
        checkbox.checked = true;
        itemElement.classList.add('checked');
      }
      
      applyMultiClassFilter();
    }

    function selectAllClasses() {
      const classes = collectClasses();
      selectedClasses.clear();
      classes.forEach(c => selectedClasses.add(c));
      
      document.querySelectorAll('.class-checkbox-item').forEach(item => {
        item.classList.add('checked');
        item.querySelector('input[type="checkbox"]').checked = true;
      });
      
      applyMultiClassFilter();
    }

    function deselectAllClasses() {
      selectedClasses.clear();
      
      document.querySelectorAll('.class-checkbox-item').forEach(item => {
        item.classList.remove('checked');
        item.querySelector('input[type="checkbox"]').checked = false;
      });
      
      applyMultiClassFilter();
    }

    function applyMultiClassFilter() {
      // Only apply multi-class filter in annual view
      if (!document.getElementById('annual').classList.contains('active')) {
        return;
      }
      
      document.querySelectorAll('.activity-tag').forEach(tag => {
        const activityType = (tag.getAttribute('data-type') || "").toUpperCase();
        const dayContainer = tag.closest('.mini-day');
        
        if (!dayContainer) return;
        
        // Ripristino di sicurezza per l'etichetta
        tag.style.display = '';
        
        // Show if no classes are selected (show all) or if the activity type is in selected classes
        const shouldShow = selectedClasses.size === 0 || selectedClasses.has(activityType);
        
        if (shouldShow) {
          dayContainer.style.display = '';
          tag.style.display = ''; // FIX: ripristina etichetta quando visibile
          // If the day has activity, make sure it's styled properly
          if (isClassCode(activityType)) {
            dayContainer.classList.add('has-activity');
            const color = activityColors[activityType] || '#667eea';
            dayContainer.style.background = color;
            dayContainer.style.color = '#fff';
          }
        } else {
          // Hide the activity but keep the day visible with default styling
          dayContainer.classList.remove('has-activity');
          dayContainer.style.background = '#fff';
          dayContainer.style.color = 'var(--text-primary)';
          tag.style.display = 'none';
        }
      });
      
      // Handle days that have no activity tags but should be visible
      document.querySelectorAll('.mini-day:not(.muted)').forEach(day => {
        const activityTag = day.querySelector('.activity-tag');
        if (!activityTag) {
          // This day has no activities, always show it with default styling
          day.style.display = '';
          day.classList.remove('has-activity');
          day.style.background = '#fff';
          day.style.color = 'var(--text-primary)';
        }
      });
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){ 
  if (typeof populateClassFilter==='function'){ 
    populateClassFilter('classFilterMonth'); 
    populateClassFilter('classFilterYear'); 
  } 
});
</script>
</body>
</html>
